# Analyse de la logique métier Looping – Objectif : même niveau pour Barrel MCD

Ce document synthétise la **logique métier** observée dans le logiciel **Looping** (binaire `Looping.exe`, fichiers `.loo`) et la compare à l’état actuel de **Barrel MCD**. L’objectif est d’aligner Barrel MCD sur les mêmes compétences : entités, attributs, cardinalités MCD/MLD, transformations MCD→MLD, MPD, BDD, SQL, CIF, contraintes, règles de gestion.

**Sources** : extraction de chaînes dans `Looping.exe` (ASCII et UTF-16), fichier `.loo` (script `extract_loo_strings.py`), documentation existante Barrel MCD (`FONCTIONNALITES_MCD_LOOPING.md`, `LOGIQUE_METIER_PARTAGEE.md`, `LOGICIELS_REFERENCE_TRANSCRIPTION.md`).

---

## 1. Entités

### 1.1 Ce que Looping fait (observé)

| Concept | Chaîne / comportement |
|--------|------------------------|
| Nom d’entité | « Nom de l'entité », « Entité », « Entite » |
| Dimensions | `HauteurTouteRubriqueEntite`, `HauteurAutoMaximumEntite`, `Largeur minimale de l'entité`, `Hauteur minimale de l'entité`, `Hauteur du titre de l'entité`, `Largeur minimum de l'entité` |
| Défaut | « défaut de l'entité », « défaut des rubriques de l'entité », « défaut des types de rubriques de l'entité » |
| Clé primaire | « Entité primaire associée », « clé primaire » |
| Lien MLD | « Lien vers l'entité », « Format du lien MLD », `ArcFormatLienMLD` |
| Contraintes | « L'entité … nécessite une association cible », « nécessite au moins une association » |

### 1.2 Barrel MCD aujourd’hui

- **Oui** : entités (nom, position, attributs, `is_weak`, `is_fictive`), hauteur calculée (header + attributs).
- **Partiel** : pas de « largeur/hauteur minimale » configurables, pas de « défaut » global entité/rubriques.
- **À faire** : options de dimension min (largeur/hauteur/titre) ; défauts par défaut pour rubriques/types si on veut coller au vocabulaire Looping.

---

## 2. Attributs (rubriques)

### 2.1 Ce que Looping fait (observé)

| Concept | Chaîne / comportement |
|--------|------------------------|
| Rubrique | « rubrique », « Les rubriques », « Type de la rubrique manquant », « Point manquant entre la table et la rubrique », « Il existe des doublons dans les rubriques » |
| Affichage | `AfficherRubrique`, `AfficherTypeDansMLD` |
| Types SQL | `VARCHAR(`, `VARCHAR2(`, `VARCHAR(max)`, `NVARCHAR(`, `NVARCHAR(max)`, `INT`, `INTEGER`, `BIGINT`, `TINYINT`, `SMALLINT`, `INT IDENTITY`, `INT AUTO_INCREMENT`, `INT GENERATED BY DEFAULT AS IDENTITY`, `DATE`, `DATETIME`, `DATETIME2`, `BIGDATETIME`, `DATETIMEOFFSET` |
| MLD | « Afficher les types dans le MLD textuel », « Types dans MLD textuel », « # dans MLD graphique » (`DiezeDansMLDGraphique`) |

### 2.2 Barrel MCD aujourd’hui

- **Oui** : attributs (nom, type, clé primaire), types en texte libre, normalisation (default, check, size, values) côté API.
- **Partiel** : pas d’option « afficher les types dans le MLD textuel » ni « # dans MLD graphique ».
- **À faire** : options d’affichage MLD (types oui/non, symbole #) ; étendre la liste de types proposés (VARCHAR2, NVARCHAR, DATETIME2, etc.) pour rapprocher Looping.

---

## 3. Cardinalités MCD

### 3.1 Ce que Looping fait (observé)

| Règle | Message / chaîne |
|-------|-------------------|
| 1,1 et association porteuse de rubriques | « La cardinalité 1,1 est interdite lorsque l'association est porteuse de rubriques » |
| Cardinalités et association | « Une association ne peut pas avoir des cardinalités … », « La cardinalité … la cardinalité … » |
| Table de correspondance | « Une association gérant une table de correspondance ne peut pas avoir de cardinalités … », « Les associations gérant une table de correspondance peuvent être porteuses de rubriques » |
| CIF | « Les cardinalités des liens de la CIF » |
| Validation | « confirmez-vous la validation de l… » (association porteuse de rubriques) |

Cardinalités : **0,1 | 1,1 | 0,n | 1,n** (Merise).

### 3.2 Barrel MCD aujourd’hui

- **Oui** : cardinalités 0,1 | 1,1 | 0,n | 1,n, normalisation, validation (noms uniques, liens, cycles héritage) dans `merise_rules.py`.
- **Oui** : règle « 1,1 interdite si association porteuse de rubriques » (`validate_cardinality_1_1_no_attributes`).
- **Oui** : « table de correspondance » = association n-n ; seules ces associations peuvent être porteuses de rubriques (`validate_association_with_attributes_must_be_n_n`).
- **Oui** : doublons dans les rubriques interdis, type de rubrique obligatoire, entité doit avoir au moins une association.
- **À faire** : contraintes CIF sur les cardinalités si on expose les CIF.

---

## 4. Associations et liens

### 4.1 Ce que Looping fait (observé)

- **Relation** : `CDrawRelation`, « Relation », « Nom de l'association ».
- **Arc / lien** : `CDrawArc`, « Lien », « Lien 9 », « Lien 10 »… (un arc = un lien entité–association).
- **Table de correspondance** : « créer une table de correspondance dans le MLD », « table de correspondance » (association n-n → table de liaison).
- **N-aire** : « Une CIF n'a d'intérêt qu'avec des associations n-aires (n>2) », « association reliant plus de 2 entités », « toutes les cardinalités … ».

### 4.2 Barrel MCD aujourd’hui

- **Oui** : un lien = un arc (association_links), table de liaison pour n-n dans MCD→MLD.
- **Oui** : règles Looping sur les rubriques (pas de 1,1 si rubriques ; rubriques uniquement en n-n ; doublons interdits ; type obligatoire).
- **Partiel** : associations à 2 entités (ou 1 en réflexif) ; pas de représentation explicite des associations n-aires (n>2) ni de règles dédiées.
- **À faire** : support explicite des associations n-aires (n>2) en MCD et dans les règles de passage au MLD (et CIF si on les ajoute).

---

## 5. Cardinalités MLD et transformation MCD → MLD

### 5.1 Ce que Looping fait (observé)

| Concept | Chaîne / comportement |
|--------|------------------------|
| MLD textuel | « Exporter le MLD textuel », « MLD textuel », « Exportation MLD textuel vers … », « Erreur dans le MLD : impossible d'exporter le MLD textuel » |
| Table de correspondance | « créer une table de correspondance dans le MLD » |
| Format lien MLD | `ArcFormatLienMLD`, « Format du lien MLD », « Format lien MLD » |
| Affichage MLD | « MLD - LDD », « Couleur du fond des tables MLD », « Couleur table MLD » |

### 5.2 Barrel MCD aujourd’hui

- **Oui** : MCD → MLD dans `views/model_converter.py` (`_convert_to_mld`) et `api/services/mcd_service.py` (`mcd_to_mld`) : entité → table, 1,n/0,n → FK côté « n », n-n → table de liaison, héritage → FK enfant→parent.
- **Oui** : export MLD (JSON) et panneau MLD/SQL (onglet MLD).
- **Partiel** : pas d’export « MLD textuel » (format texte type Looping) ; pas d’options « couleur tables MLD » ou « format lien MLD ».
- **À faire** : export MLD textuel (format lisible) ; options d’affichage/export MLD (couleur, format des liens) si on veut parité avec Looping.

---

## 6. MPD (Modèle Physique des Données) et LDD (Script BDD)

### 6.1 Ce que Looping fait (observé)

| Concept | Chaîne / comportement |
|--------|------------------------|
| Script SQL / LDD | « Exporter le script SQL », « Script SQL (*.txt …) », « Le script SQL n'a pas … », « Paramètres LDD », « Script LDD au format TXT », « Configuration du SGBD personnalisé », « Code SQL de début … », « Code SQL de fin de script », « Code SQL de début de création de table … [Nom_Table] », « Code SQL de fin de création de table … [Nom_Table] » |
| CREATE / ALTER | « CREATE TABLE », « ALTER TABLE », « à la fin de CREATE TABLE », « à la fin de ALTER TABLE », « DoCmd.RunSQL "CREATE TABLE » (VB-Access) |
| SGBD | « MySQL », « PostgreSQL », « SQL Server », « SQLite » (strings UTF-16) |
| Export VB-Access | « Exporter le script SQL pour VB-Access » |

### 6.2 Barrel MCD aujourd’hui

- **Oui** : chaîne MCD → MLD → MPD → SQL dans `views/model_converter.py` (`generate_mpd`, `generate_sql_from_mpd`), API `to-sql` avec `dbms` (mysql, postgresql, sqlite).
- **Oui** : CREATE TABLE, PRIMARY KEY, clés étrangères, contraintes d’unicité (héritage).
- **Partiel** : pas d’ALTER TABLE généré ; pas de SQL Server ni de « SGBD personnalisé » ; pas d’export spécifique VB-Access.
- **À faire** : option ALTER TABLE (évolution de schéma) ; ajout SQL Server ; paramétrage SGBD personnalisé (types, syntaxe) ; option export VB-Access si pertinent.

---

## 7. Contraintes et CIF (Contraintes d’Intégrité Fonctionnelle)

### 7.1 Ce que Looping fait (observé)

| Concept | Chaîne / comportement |
|--------|------------------------|
| Contrainte | « Contrainte », « Nom de la contrainte », `CDrawArcContrainte`, `CDrawContrainte`, « La contrainte … », « CONSTRAINT », « ON UPDATE CASCADE » |
| CIF | « CIF », « ID_DRAW_CIF », « Nom de la cif », « Les cardinalités des liens de la CIF », « Une CIF n'a d'intérêt qu'avec des associations n-aires (n>2) », « Une CIF doit … », `CifMultiCible`, `CDrawArcCif`, `CDrawCif` |
| Inclusion | « Inclusion », « Une contrainte d'inclusion nécessite … » (au moins une entité, une association cible, etc.) |
| Inter-associations | « Une contrainte inter-associations concerne au moins deux associations », « Une contrainte inter-associations n… » |
| Analyse | « Analyse LDD » |

### 7.2 Barrel MCD aujourd’hui

- **Python** : `models/cif_constraints.py` (CIFManager, CIFType : FUNCTIONAL, INTER_ASSOCIATION, UNIQUE, EXCLUSION), non exposé dans l’API ni en Flutter.
- **Non** : pas de dessin CIF sur le canvas, pas de validation MCD prenant en compte les CIF, pas de génération SQL des contraintes CIF.
- **À faire** : exposer CIF dans l’API (CRUD contraintes) ; représentation CIF sur le MCD (Flutter) ; règles de validation (inclusion, inter-associations, n-aires) ; prise en compte dans MCD→MLD/SQL (contraintes, triggers ou CHECK si applicable).

---

## 8. Règles de gestion

### 8.1 Ce que Looping fait (observé)

- « Règles » (bouton), `CDrawArcRegle`, « Règles de gestion avec possibilité de spécifier du code SQL » (référence doc Barrel MCD).

### 8.2 Barrel MCD aujourd’hui

- **Python** : `models/business_rules.py` (BusinessRule, RuleType : ENTITY, ASSOCIATION, ATTRIBUTE, GLOBAL ; condition, action), non exposé dans l’API ni en Flutter.
- **À faire** : exposer les règles dans l’API ; édition dans l’UI (cible, condition, action, priorité) ; possibilité de code SQL/script pour les actions si on vise le même niveau que Looping.

---

## 9. Héritage et généralisation

### 9.1 Ce que Looping fait (observé)

- « Généralisation », « Rétro-ingénierie » (menu), arcs d’héritage (`A_H 36`, etc.), entités parent/enfant.

### 9.2 Barrel MCD aujourd’hui

- **Oui** : `inheritance_links` (parent, child), affichage et édition, validation (pas de cycle).
- **Partiel** : pas de distinction explicite spécialisation/généralisation ; pas de copie automatique des attributs hérités dans l’UI.
- **À faire** : option « copie des attributs hérités » en lecture ; libellés explicites généralisation/spécialisation.

---

## 10. Entités fictives et transformation association → entité

### 10.1 Ce que Looping fait (observé)

- « Transformation association en entité avec identifiants relatifs » (référence doc Barrel MCD).

### 10.2 Barrel MCD aujourd’hui

- **Oui** : entité fictive (`is_fictive`), exclue du MLD/SQL.
- **Non** : pas de transformation « association → entité » avec identifiants relatifs.
- **À faire** : fonction de transformation (association porteuse de rubriques → entité + liens + identifiants relatifs) si on veut la même capacité que Looping.

---

## 11. Export, présentation, erreurs

### 11.1 Ce que Looping fait (observé)

| Concept | Chaîne / comportement |
|--------|------------------------|
| Export | « Exporter le modèle », « Exportation du script vers … », « voir les erreurs dans le MLD textuel », « voir les erreurs dans le MLD textuel » (avant export SQL) |
| Erreurs | « La table … n'existe pas … », « La rubrique … », « La contrainte … », « Point virgule manquant », « Dans CREATE TABLE », « Dans ALTER TABLE », « FK dans ALTER TABLE » |
| Police | « Police cardinalité » |

### 11.2 Barrel MCD aujourd’hui

- **Oui** : export image, copier MCD/MLD/SQL, panneau MLD/SQL avec onglets, validation MCD (liste d’erreurs).
- **Partiel** : pas de validation bloquante avant export SQL ; pas de paramétrage « police cardinalité ».
- **À faire** : validation systématique avant export SQL avec message clair ; options de présentation (police cardinalité, etc.) si on veut parité.

---

## 12. Synthèse : écarts et roadmap

### 12.1 Déjà au niveau ou proche

- Entités, attributs, types, clé primaire.
- Cardinalités MCD 0,1 | 1,1 | 0,n | 1,n et validation de base.
- Un lien = un arc (association_links).
- MCD → MLD (tables, FK, table de liaison n-n, héritage).
- MLD → MPD → SQL (MySQL, PostgreSQL, SQLite).
- Entités fictives (exclues du MLD).
- Export image, copier MCD/MLD/SQL.

### 12.2 À implémenter ou renforcer pour atteindre Looping

| Domaine | Priorité | Action |
|---------|----------|--------|
| **Règles cardinalités MCD** | Haute | Règle « 1,1 interdite si association porteuse de rubriques » ; option « table de correspondance » et contraintes associées. |
| **CIF** | Haute | Exposer CIF dans l’API ; dessin CIF sur le canvas ; validation MCD + CIF ; inclusion dans MLD/SQL (contraintes/triggers). |
| **Règles de gestion** | Moyenne | Exposer règles dans l’API ; UI édition (cible, condition, action, SQL si besoin). |
| **Associations n-aires (n>2)** | Moyenne | Support en MCD et dans la conversion MCD→MLD (et CIF). |
| **MLD textuel** | Moyenne | Export MLD en format texte lisible (style Looping). |
| **Options MLD** | Basse | « Afficher les types dans le MLD », « # dans MLD graphique », couleur tables MLD. |
| **MPD / SQL** | Moyenne | ALTER TABLE (évolutions) ; SQL Server ; SGBD personnalisé ; option VB-Access. |
| **Transformation assoc. → entité** | Basse | Transformation « association → entité » avec identifiants relatifs. |
| **Présentation** | Basse | Police cardinalité, dimensions min entité, défauts rubriques. |

### 12.3 Ordre de mise en œuvre suggéré

1. **Règles MCD** : 1,1 + rubriques, puis table de correspondance.
2. **CIF** : API + modèle de données, puis affichage et validation, puis impact MLD/SQL.
3. **Règles de gestion** : API + UI minimale (liste, édition).
4. **N-aires** : extension du modèle (liens multiples par association) et règles de conversion.
5. **MLD textuel** : format d’export texte.
6. **MPD/SQL** : ALTER TABLE, SQL Server, SGBD personnalisé selon besoins.

---

## 13. Fichiers Barrel MCD concernés

| Rôle | Fichiers |
|------|----------|
| Validation MCD, cardinalités | `api/services/merise_rules.py` |
| MCD → MLD → SQL | `api/services/mcd_service.py`, `views/model_converter.py` |
| CIF (logique existante) | `models/cif_constraints.py` |
| Règles de gestion (logique existante) | `models/business_rules.py` |
| Canvas, état MCD | `barrelmcd_flutter/lib/core/mcd_state.dart`, `barrelmcd_flutter/lib/widgets/mcd_canvas.dart` |
| Panneau MLD/SQL | `barrelmcd_flutter/lib/screens/mld_sql_panel.dart` |
| API routes | `api/routers/mcd.py` |

Ce document pourra être mis à jour au fur et à mesure des évolutions pour garder la trace des écarts avec Looping et de la roadmap Barrel MCD.
